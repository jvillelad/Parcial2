name: KNOX Managed Scan

on:
  push:
    branches: ["main", "master", "develop"]
  workflow_dispatch:

jobs:
  managed-scan:
    runs-on: ubuntu-latest
    environment: KNOXCICDSEC
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y curl jq

      - name: Validate required env vars
        env:
          SL_API_URL: ${{ vars.SL_API_URL }}
          SL_TRIGGER_TOKEN: ${{ secrets.SL_TRIGGER_TOKEN }}
          SL_ORG_KEY: ${{ vars.SL_ORG_KEY }}
          SL_PROJECT_KEY: ${{ vars.SL_PROJECT_KEY }}
          SL_REPO_WORKSPACE: ${{ vars.SL_REPO_WORKSPACE }}
          SL_REPO_SLUG: ${{ vars.SL_REPO_SLUG }}
        run: |
          set -euo pipefail
          fail=0
          for k in SL_API_URL SL_TRIGGER_TOKEN SL_ORG_KEY SL_PROJECT_KEY SL_REPO_WORKSPACE SL_REPO_SLUG; do
            if [ -z "${!k:-}" ]; then
              echo "$k=MISSING"
              fail=1
            else
              echo "$k=OK"
            fi
          done
          [ "$fail" -eq 0 ] || { echo "Missing required configuration"; exit 3; }

      - name: Trigger managed scan and poll status
        env:
          SL_API_URL: ${{ vars.SL_API_URL }}
          SL_TRIGGER_TOKEN: ${{ secrets.SL_TRIGGER_TOKEN }}
          SL_ORG_KEY: ${{ vars.SL_ORG_KEY }}
          SL_PROJECT_KEY: ${{ vars.SL_PROJECT_KEY }}
          REPO_WORKSPACE: ${{ vars.SL_REPO_WORKSPACE }}
          REPO_SLUG: ${{ vars.SL_REPO_SLUG }}
          REPO_BRANCH: ${{ github.ref_name }}
          SCAN_PROFILE: strict
          WAIT_TIMEOUT_SEC: "1800"
          POLL_INTERVAL_SEC: "5"
        run: |
          set -euo pipefail
          API="${SL_API_URL%/}"
          TRIGGER_URL="${API}/api/v1/orgs/${SL_ORG_KEY}/projects/${SL_PROJECT_KEY}/scans/trigger"
          STATUS_BASE="${API}/api/v1/orgs/${SL_ORG_KEY}/projects/${SL_PROJECT_KEY}/scans/jobs"

          echo "Trigger URL: ${TRIGGER_URL}"
          echo "Repo: ${REPO_WORKSPACE}/${REPO_SLUG}@${REPO_BRANCH}"

          # Trigger async: wait_for_result=false (evita 504 en este request)
          RESP="$(curl -sS -u "x-token-auth:${SL_TRIGGER_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"scan_profile\":\"${SCAN_PROFILE}\",\"wait_for_result\":false,\"repo_workspace\":\"${REPO_WORKSPACE}\",\"repo_slug\":\"${REPO_SLUG}\",\"repo_branch\":\"${REPO_BRANCH}\"}" \
            "${TRIGGER_URL}")"

          echo "$RESP" | jq .
          JOB_ID="$(echo "$RESP" | jq -r '.scan_job_id // empty')"
          [ -n "$JOB_ID" ] || { echo "scan_job_id missing"; exit 4; }

          deadline=$(( $(date +%s) + WAIT_TIMEOUT_SEC ))

          while [ "$(date +%s)" -lt "${deadline}" ]; do
            ST="$(curl -sS -u "x-token-auth:${SL_TRIGGER_TOKEN}" "${STATUS_BASE}/${JOB_ID}")"
            STATUS="$(echo "$ST" | jq -r '.job.status // "unknown"')"
            echo "job=${JOB_ID} status=${STATUS}"

            if [[ "$STATUS" == "succeeded" ]]; then
              echo "$ST" | jq .
              VIOLATED="$(echo "$ST" | jq -r '.job.policy_violated // false')"
              if [[ "$VIOLATED" == "true" ]]; then
                echo "Policy violated"
                exit 1
              fi
              exit 0
            fi

            if [[ "$STATUS" == "failed" || "$STATUS" == "dead_letter" ]]; then
              echo "$ST" | jq .
              exit 1
            fi

            sleep "${POLL_INTERVAL_SEC}"
          done

          echo "Timeout waiting for terminal scan status"
          exit 124
