name: KNOX Managed Scan

on:
  push:
    branches: ["main", "master", "develop"]
  workflow_dispatch:

jobs:
  managed-scan:
    runs-on: ubuntu-latest
    environment: KNOXCICDSEC

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y curl jq

      - name: Validate required vars
        env:
          SL_API_URL: ${{ vars.SL_API_URL }}
          SL_TRIGGER_TOKEN: ${{ secrets.SL_TRIGGER_TOKEN }}
          SL_ORG_KEY: ${{ vars.SL_ORG_KEY }}
          SL_PROJECT_KEY: ${{ vars.SL_PROJECT_KEY }}
          SL_REPO_WORKSPACE: ${{ vars.SL_REPO_WORKSPACE }}
          SL_REPO_SLUG: ${{ vars.SL_REPO_SLUG }}
        run: |
          set -euo pipefail
          for k in SL_API_URL SL_TRIGGER_TOKEN SL_ORG_KEY SL_PROJECT_KEY SL_REPO_WORKSPACE SL_REPO_SLUG; do
            [ -n "${!k:-}" ] || { echo "$k missing"; exit 3; }
          done

      - name: Trigger and wait
        env:
          SL_API_URL: ${{ vars.SL_API_URL }}
          SL_TRIGGER_TOKEN: ${{ secrets.SL_TRIGGER_TOKEN }}
          SL_ORG_KEY: ${{ vars.SL_ORG_KEY }}
          SL_PROJECT_KEY: ${{ vars.SL_PROJECT_KEY }}
          REPO_WORKSPACE: ${{ vars.SL_REPO_WORKSPACE }}
          REPO_SLUG: ${{ vars.SL_REPO_SLUG }}
          REPO_BRANCH: ${{ github.ref_name }}
          SCAN_PROFILE: strict
          WAIT_FOR_RESULT: "true"
          WAIT_TIMEOUT_SEC: "1200"
          POLL_INTERVAL_SEC: "5"
        run: |
          set -euo pipefail

          API="${SL_API_URL%/}"
          TRIGGER_URL="${API}/api/v1/orgs/${SL_ORG_KEY}/projects/${SL_PROJECT_KEY}/scans/trigger"
          STATUS_BASE="${API}/api/v1/orgs/${SL_ORG_KEY}/projects/${SL_PROJECT_KEY}/scans/jobs"

          PAYLOAD="$(jq -nc \
            --arg scan_profile "${SCAN_PROFILE}" \
            --argjson wait_for_result "${WAIT_FOR_RESULT}" \
            --argjson wait_timeout_sec "${WAIT_TIMEOUT_SEC}" \
            --argjson poll_interval_sec "${POLL_INTERVAL_SEC}" \
            --arg repo_workspace "${REPO_WORKSPACE}" \
            --arg repo_slug "${REPO_SLUG}" \
            --arg repo_branch "${REPO_BRANCH}" \
            '{scan_profile:$scan_profile,wait_for_result:$wait_for_result,wait_timeout_sec:$wait_timeout_sec,poll_interval_sec:$poll_interval_sec,repo_workspace:$repo_workspace,repo_slug:$repo_slug,repo_branch:$repo_branch}'
          )"

          echo "Trigger URL: ${TRIGGER_URL}"
          echo "Repo: ${REPO_WORKSPACE}/${REPO_SLUG}@${REPO_BRANCH}"

          RESP_FILE="$(mktemp)"
          HDR_FILE="$(mktemp)"
          HTTP_CODE="$(
            curl -sS -D "${HDR_FILE}" -o "${RESP_FILE}" -w "%{http_code}" \
              -u "x-token-auth:${SL_TRIGGER_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "${PAYLOAD}" \
              "${TRIGGER_URL}"
          )"

          echo "trigger_http=${HTTP_CODE}"
          sed -n '1,20p' "${HDR_FILE}"
          cat "${RESP_FILE}" | jq . || cat "${RESP_FILE}"

          if [ "${HTTP_CODE}" -lt 200 ] || [ "${HTTP_CODE}" -ge 300 ]; then
            exit 22
          fi

          JOB_ID="$(jq -r '.scan_job_id // empty' "${RESP_FILE}")"
          [ -n "${JOB_ID}" ] || { echo "scan_job_id missing"; exit 4; }

          while true; do
            ST_FILE="$(mktemp)"
            ST_CODE="$(
              curl -sS -o "${ST_FILE}" -w "%{http_code}" \
                -u "x-token-auth:${SL_TRIGGER_TOKEN}" \
                "${STATUS_BASE}/${JOB_ID}"
            )"

            if [ "${ST_CODE}" -lt 200 ] || [ "${ST_CODE}" -ge 300 ]; then
              echo "status_http=${ST_CODE}"
              cat "${ST_FILE}" | jq . || cat "${ST_FILE}"
              exit 23
            fi

            STATUS="$(jq -r '.job.status // "unknown"' "${ST_FILE}")"
            echo "job=${JOB_ID} status=${STATUS}"

            if [[ "${STATUS}" == "succeeded" ]]; then
              VIOLATED="$(jq -r '.job.policy_violated // false' "${ST_FILE}")"
              cat "${ST_FILE}" | jq .
              [[ "${VIOLATED}" == "true" ]] && exit 1
              exit 0
            fi

            if [[ "${STATUS}" == "failed" || "${STATUS}" == "dead_letter" ]]; then
              cat "${ST_FILE}" | jq .
              exit 1
            fi

            sleep 5
          done
